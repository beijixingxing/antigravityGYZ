# Gemini Share Proxy - 1Panel 部署指南 (自动脚本版)

本指南已针对 1Panel 优化，解决了端口冲突和数据库初始化问题。

## 1. 本地打包 (Windows)

为了确保文件完整性，请在项目根目录 (`D:\AI\gongyizhan`) 打开 PowerShell 运行以下命令：

```powershell
# 1. 清理旧文件
if (Test-Path deploy_tmp) { Remove-Item deploy_tmp -Recurse -Force }
if (Test-Path gemini-deploy.zip) { Remove-Item gemini-deploy.zip -Force }

# 2. 创建目录结构
New-Item -ItemType Directory -Force -Path "deploy_tmp\gemini-app" | Out-Null
$dest = "deploy_tmp\gemini-app"

# 3. 复制关键文件
Copy-Item -Path "src", "client", "prisma", "scripts" -Destination $dest -Recurse -Force
Copy-Item -Path "Dockerfile", "docker-compose.yml", "package.json", "package-lock.json", "tsconfig.json", "vite.config.ts" -Destination $dest

# 4. 创建忽略文件
Set-Content -Path "$dest\.dockerignore" -Value "node_modules`r`ndist`r`n.git`r`n.env"

# 5. 压缩
Compress-Archive -Path "deploy_tmp\*" -DestinationPath "gemini-deploy.zip"

# 6. 清理
Remove-Item deploy_tmp -Recurse -Force

Write-Host "✅ 打包完成！请上传 gemini-deploy.zip" -ForegroundColor Green
```

---

## 2. 1Panel 部署步骤

### 第一步：上传代码
1.  进入 1Panel **「主机」** -> **「文件」**。
2.  进入目录 `/opt/1panel/apps`。
3.  上传并解压 `gemini-deploy.zip`。
4.  进入解压后的 `gemini-app` 目录，确认能看到 `docker-compose.yml`。

### 第二步：创建编排
1.  进入 **「容器」** -> **「编排」** -> **「创建编排」**。
2.  **名称**：`gemini-proxy`
3.  **类型**：选择 **「路径选择」**。
4.  **路径**：选择 `/opt/1panel/apps/gemini-app`。
5.  点击 **「确认」**。

> **注意**：我们已经预先将 Postgres 端口改为 `15432`，Redis 端口改为 `16379`，因此**不需要**手动修改端口，直接运行即可。

### 第三步：验证运行
1.  等待编排状态变为 **「已启动」**（绿色）。
2.  点击编排名称，查看 **「日志」**。
3.  看到 `[System] Server listening on http://0.0.0.0:3000` 即表示成功。
4.  **数据库迁移**：容器启动时会自动执行 `npx prisma db push`，无需手动操作。

---

## 3. 访问设置

1.  **「网站」** -> **「创建网站」** -> **「反向代理」**。
2.  **代理地址**：`127.0.0.1:3000`。
3.  访问你的域名即可。

---

## 常见问题

*   **如果启动失败**：
    查看 `app` 容器日志。如果是 `Connection refused`，可能是数据库启动较慢，容器会自动重启重试，通常等待 1-2 分钟即可恢复。
*   **管理员账号**：
    进入 Postgres 容器修改：
    ```bash
    docker exec -it gemini_postgres psql -U gemini_user -d gemini_proxy -c "UPDATE \"User\" SET role = 'ADMIN' WHERE email = '你的邮箱';"
    ```